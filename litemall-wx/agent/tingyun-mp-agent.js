"use strict";var i=wx;function l(){return+new Date}var n=[],m={context:null},a={networkType:"",system:i.getSystemInfoSync()};function t(t){n.push({timestamp:l(),route:t})}function e(){n=[]}function r(){return n.slice()}function o(n){return function(t){return"Array"===n&&Array.isArray?Array.isArray(t):Object.prototype.toString.call(t)==="[object "+n+"]"}}var c=o("String"),u=o("Array"),v=o("Function"),y=o("Object"),s=o("Number");function f(t,n){return function(){if(v(n))try{n.apply(this,arguments)}catch(t){}if(v(t))return t.apply(this,arguments)}}function h(n,e,r){return function(){var t;if(v(e))try{e.apply(this,arguments)}catch(t){}if(v(n)&&(t=n.apply(this,arguments)),v(r))try{r.apply(this,arguments)}catch(t){}return t}}function p(t,n){if(y(t)&&v(t.handler)){var e=t.name,r=t.handler;n[e]=f(n[e],r),n[e]._ty_hook=!0}}var d=function(){function t(t){return t<0?NaN:t<=30?0|Math.random()*(1<<t):t<=53?(0|Math.random()*(1<<30))+(0|Math.random()*(1<<t-30))*(1<<30):NaN}function n(t,n){for(var e=t.toString(16),r=n-e.length,a="0";0<r;r>>>=1,a+=a)1&r&&(e=a+e);return e}return function(){return n(t(32),8)+"-"+n(t(16),4)+"-"+n(16384|t(12),4)+"-"+n(32768|t(14),4)+"-"+n(t(48),12)}}();function g(t){return t&&c(t)?JSON.parse(t):t}function x(t){try{return g(t)}catch(t){}return null}function b(t){var n="";try{n=JSON.stringify(t)}catch(t){n=""}return n}function q(t){return t+""}function T(t){return t?y(t)?b(t).length:c(t)?t.length:t instanceof ArrayBuffer?t.byteLength:t.length?t.length:0:0}var I="recordTyTime",S="TINGYUN_UID",A="custom",k="TRIGGER_LIFECYCLE",E="2.6.4",_=1e4,O=20,P="event",N="request",w="api",C="timer",R={};function j(t){R=t||{}}var L={},D=[],M=0,G={},U={uniqueId:0,requestId:0,apiId:0,otherActions:[],eventActions:[]},H={canSend:!1,sent:!1,apiRemain:0};function Y(){L={},D=[],M=0,H.apiRemain=0,U={uniqueId:0,requestId:0,apiId:0,otherActions:[],eventActions:[]}}function F(t){if(U.eventActions||(U.eventActions=[]),U.otherActions||(U.otherActions=[]),t)if(t.type===P){var n=R&&R.eventMaxSize||O;U.eventActions&&U.eventActions.length>=n&&U.eventActions.shift(),U.eventActions.push(t)}else U.otherActions.push(t)}function J(){M=l()}var X=6e5,z="TY_SAMPLING",B=i.getStorageSync(z),K=!1;function V(t){R.key&&R.beacon&&i.request({url:"".concat(R.beacon,"/mp-config/config/pullSampling?encodeMpId=").concat(R.key),method:"GET",_no_record:!0,success:function(t){var n=t.data||{},e=n.code,r=n.data;200===e&&r&&(B=r.sampling||1,i.setStorageSync(z,B))},fail:function(){B=1},complete:function(){t&&t(B)}})}function Q(){""===B&&(B=+R.sampleRate||1,V());var t=Math.random();K=t<=B}setInterval(V,X);var W={uid:Z(),sid:d(),v:"1.3.4",at:"wx"};function Z(){var t=i.getStorageSync(S);return t||(t=d(),i.setStorageSync(S,t)),t}function $(t){if(K){var n=Object.assign({},W,a||{},{key:R.key},t||{});n.launch=!t,i.request({url:"".concat(R.beacon,"/mp-app"),data:n,method:"POST",_no_record:!0,success:function(){}})}}function tt(t){if(K&&(k===t&&(H.canSend=!0),!H.sent&&H.canSend)){var n=Object.assign({},{path:G.current,pageEvent:Object.assign({},L),errs:D.slice(),fromPath:G.prev||"",actions:(U.eventActions||[]).concat(U.otherActions||[])},Object.assign({},W,a||{},{key:R.key}),0<M?{ct:M}:{}),e=r();e&&(n.routeTrack=e),Y(),H.sent=!0,H.canSend=!1,i.request({url:"".concat(R.beacon,"/mp-page"),data:n,method:"POST",_no_record:!0,success:function(){}})}}function nt(t){Q();var n=t.path,e=t.query,r=t.scene;a.openPath=n,a.query=e,a.scene=r,i.getNetworkType({success:function(t){a.networkType=t.networkType},complete:function(){$()}})}function et(t){var n="",e="";if(c(t)?n=t:t&&(n=t.stack,e=t.message),n){var r={time:l(),stack:n};e&&(r.msg=e),D.push(r)}}function rt(){var t=r();e();var n=G.current;G.prev="",G.current="",$({routeTrack:t,closePath:n})}function at(t,n){t=t.split("."),n=n.split(".");for(var e=Math.max(t.length,n.length);t.length<e;)t.push("0");for(;n.length<e;)n.push("0");for(var r=0;r<e;r++){var a=parseInt(t[r]),i=parseInt(n[r]);if(i<a)return 1;if(a<i)return-1}return 0}function it(t,n){var e="";return t&&t.system&&(e=t.system.SDKVersion),e&&n?at(e,n):-1}var ot=[{name:"onLaunch",handler:nt},{name:"onError",handler:et},{name:"onHide",handler:rt}];function ct(n){return ot.forEach(function(t){p(t,n)}),n}function ut(t){return 0<=it(a,E)?t:ct.apply(this,arguments)}function st(){var n=App;App=function(t){t=ct(t),n&&n.call(this,t)}}function ft(t){return!R.pages||!u(R.pages)||-1<R.pages.indexOf(t)}function ht(){ft(this.route)&&(L.onLoad=l())}function pt(){ft(this.route)&&(L.onShow=l(),t(this.route),G.prev=G.current,G.current=this.route,H.sent=!1)}function dt(){ft(this.route)&&(L.onReady=l())}function lt(){ft(this.route)&&(L.onHide=l(),tt(k))}function mt(){ft(this.route)&&(L.onUnload=l(),tt(k))}var vt=[{name:"onLoad",handler:ht},{name:"onShow",handler:pt},{name:"onReady",handler:dt},{name:"onHide",handler:lt},{name:"onUnload",handler:mt}];function yt(t,n){for(var e in t)if(t.hasOwnProperty(e)&&v(t[e])&&!t[e]._ty_hook&&v(n)){var r=t[e];t[e]=n.call(this,e,r),t[e]._ty_hook=!0}}var gt=[N,w,C];function xt(){var n={};return gt.forEach(function(t){n[t]={current:0,children:0}}),n}function bt(t,n,e,r,a){this.id=++U.uniqueId,this.parent=t||null,this.name=n||"<root>",this.type=e||"event",this.subType="event"===this.type?r||"tap":r,this.requests=[],this.apis=[],this.remain=xt(),this.s=l(),this.e=null,this.data=a;var i=this,o=R&&R.eventTimeout||_;this.i=setTimeout(function(){i.timeout()},o),this.closed=!1,this.path=G.current,this.prevPath=G.prev}bt.prototype.end=function(n,t){if(!this.closed){if(n)if(n.type===N||n.type===w){var e=n.requests||[],r=n.apis||[];this.requests.map(function(t){"".concat(t.url,"-").concat(t.requestId)===n.name&&(t.requests=e,t.apis=r)}),this.apis.map(function(t){"".concat(t.name,"-").concat(t.apiId)===n.name&&(t.requests=e,t.apis=r)})}else if(n.type===C){var a=n.requests||[],i=n.apis||[];this.requests=[].concat.call(this.requests||[],a),this.apis=[].concat.call(this.apis||[],i)}if(this.isNoRemain()||t)if(this.e=l(),this.closed=!0,this.i&&clearTimeout(this.i),this.parent)this.parent.end(this);else F(this.composeActionData()),m.context=null}},bt.prototype.isNoRemain=function(t){var n=!0;for(var e in this.remain){if(this.remain.hasOwnProperty(e))if(!(this.remain[e].current<=0&&(!!t||this.remain[e].children<=0))){n=!1;break}}return n},bt.prototype.timeout=function(){this.end(null,!0)},bt.prototype.setData=function(t){this.data=t},bt.prototype.composeActionData=function(){var t={id:this.id,name:this.name,type:this.type,start:this.s,end:this.e,duration:0<this.e-this.s?this.e-this.s:0,requests:(this.requests||[]).slice(),apis:(this.apis||[]).slice(),data:this.data||{},path:this.path,prevPath:this.prevPath};return this.type!==N&&this.type!==w||delete(t=Object.assign({},t,this.data)).data,t},bt.prototype.canEnd=function(t,n){return this.isNoRemain(!0)},bt.prototype.isEventChildContext=function(){for(var t=this.parent,n=!1;null!=t;){if("event"===t.type){n=!0;break}t=t.parent}return n},bt.prototype.updateRemain=function(t,n){n=n||N;var e=t||0;this.remain[n].current=this.remain[n].current+e;for(var r=this.parent;r;)r.remain[n].children=r.remain[n].children+e,r=r.parent},Object.defineProperty(bt.prototype,"current",{get:function(){return m.context},enumerable:!0,configurable:!0}),Object.defineProperty(bt,"createEvent",{value:function(t,n,e,r,a){return new bt(t,n,e||"event",r||null,a)},enumerable:!0,configurable:!0,writable:!0});var qt="tyname";function Tt(t){return!t||"tap"!==t.type||!y(t.target)||!y(t.currentTarget)||null==t.timeStamp}function It(t,n){var e,r=t.target||{},a=r.offsetLeft,i=r.offsetTop,o=r.id,c=r.dataset,u=t.detail||{},s=u.x,f=u.y;t._relatedInfo&&(e=t._relatedInfo.anchorTargetText);var h={target:{offsetLeft:a,offsetTop:i,id:o,x:s,y:f},dataset:{name:c[qt],targetName:e,methodName:n}},p=n||"";m.context=bt.createEvent(null,p,"event",t.type,h)}function St(){m.context&&m.context.canEnd()&&m.context.end()}function At(r,a){return function(){var t,n=arguments[0]||{},e=Tt(n);if(!e)try{It.call(this,n,r)}catch(t){}try{t=a.apply(this,arguments)}finally{if(!e)try{St.call(this)}catch(t){}}return t}}function kt(e){var r=m.context;return function(){var t,n=m.context;m.context=r;try{t=e.apply(this,arguments)}finally{n&&!n.closed&&(m.context=n)}return t}}function Et(t){return kt(t)}function _t(n){return vt.forEach(function(t){p(t,n)}),yt(n,At),n[I]=J,n}function Ot(t){return 0<=it(a,E)?t:_t.apply(this,arguments)}function Pt(){var n=Page;Page=function(t){t=_t(t),n&&n.call(this,t)}}var Nt=i.request;function wt(t,n){if(t){var e=x(t["X-Tingyun-Tx-Data"]);if(e&&e.r&&q(e.r)===q(n))return e}return null}function Ct(t){if(!t)return 0;var n=t.header,e=t.data,r=0;return(r=+(n&&n["Content-Length"]))&&s(r)&&!Number.isNaN(r)||(r=T(e)||0),r}function Rt(t,n){var e={},r=wt(t.header,n.r);return r&&(e.s_id=r.id,e.s_name=r.action,r.time&&(e.s_du=r.time.duration,e.s_qu=r.time.qu),e.t_id=r.trId),e}function jt(t,n,e){return{requestId:t.requestId,type:N,url:t.url,method:t.method,start:t.start,end:t.end,cbTime:t.cbTime,duration:0<t.end-t.start?t.end-t.start:0,send:T(n.data),rec:Ct(e),statusCode:e.statusCode||0}}function Lt(t,n){if(!t.context){var e="".concat(t.url,"-").concat(t.requestId);t.context=bt.createEvent(n,e,N)}m.context=t.context}function Dt(t,n,e){m.context&&m.context.setData(e);var r=m.context&&m.context.canEnd();if(r&&m.context.end(),n&&n.id===t.cid&&e){n.requests.push(e);n.remain[N].current;n.updateRemain(-1,N),n.canEnd()&&r&&n.end()}}var Mt=function(t){var f=t||{};if(!f._no_record&&f.url){var h=m.context,p={requestId:++U.requestId,url:f.url,method:f.method&&f.method.toUpperCase()||"GET",callbackContextCreated:!1,cbTime:0};p.r=l()%1e9,f.header=f.header||{},f.header["X-Tingyun-Id"]="".concat(R.id,";r=").concat(p.r);var r=f.success,a=f.fail,d=f.complete;f.success=Et(function(){var t;if(p.end||(p.end=l()),Lt(p,h),r){var n=l();try{t=r.apply(this,arguments)}finally{var e=l()-n;0<e&&(p.cbTime+=e)}}return t}),f.fail=Et(function(){var t;if(p.end||(p.end=l()),Lt(p,h),a){var n=l();try{t=a.apply(this,arguments)}finally{var e=l()-n;0<e&&(p.cbTime+=e)}}return t}),f.complete=Et(function(t){var n,e;p.end||(p.end=l());var r=R[A];if(r&&v(r))try{var a=r.apply(this,arguments);y(a)&&(e={custom:a})}catch(t){}if(Lt(p,h),d){var i=l();try{n=d.apply(this,arguments)}finally{var o=l()-i;0<o&&(p.cbTime+=o)}}var c=Rt(t,p),u=jt(p,f,t),s=Object.assign({},u,c||{},e||{});return Dt(p,h,s),n}),p.start=l(),h&&(p.cid=h.id,h.updateRemain(1))}return Nt.apply(this,arguments)};function Gt(){Object.defineProperty(i,"request",{configurable:!0,enumerable:!0,writable:!0,value:Mt})}function Ut(n){return n.methods||(n.methods={}),vt.forEach(function(t){p(t,n.methods)}),n}function Ht(t){return 0<=it(a,E)?t:Ut.apply(this,arguments)}function Yt(){var n=Component;Component=function(t){t=Ut(t),n&&n.call(this,t)}}function Ft(t,n){a.uid=t,i.setStorageSync(S,t)}function Jt(){return m.context}var Xt,zt={version:"1.3.4",setUser:Ft,hookApp:ut,hookPage:Ot,hookComponent:Ht,request:Mt,getContext:Jt},Bt=["success","fail"],Kt=[],Vt={requestPayment:{fail:function(t){var n=arguments&&t,e="fail";return n&&y(n)&&"requestPayment:fail cancel"===n.errMsg&&(e="cancel"),e}}};function Qt(){(Xt=R.hookApis||["requestPayment","scanCode","previewImage"]).forEach(function(t){-1<Kt.indexOf(t)||"request"===t||Kt.push(t)})}function Wt(t){return{apiId:t.apiId,type:w,name:t.name,success:t.success||0,fail:t.fail||0,cancel:t.cancel||0,start:t.start,end:t.end,duration:0<t.end-t.start?t.end-t.start:0,count:1}}function Zt(t,n){if(!t.context){var e="".concat(t.name,"-").concat(t.apiId);t.context=bt.createEvent(n,e,w)}m.context=t.context}function $t(t,n,e){m.context&&m.context.setData(e);var r=m.context&&m.context.canEnd();if(r&&m.context.end(),n&&n.id===t.cid&&e){n.apis.push(e);n.remain[w].current;n.updateRemain(-1,w),n.canEnd()&&r&&n.end()}}function tn(a){var n=i[a];return function(){var e=m.context,t=arguments[0]||{},r={apiId:++U.apiId,name:a};return Bt.forEach(function(n){t[n]=Et(f(t[n],function(){var t;r.end||(r.end=l()),Zt(r,e),(t=Vt[a]&&Vt[a][n]&&v(Vt[a][n])?Vt[a][n].apply(this,arguments):r[n]=1)&&(r[t]=1)}))}),t.complete=Et(h(t.complete,function(){r.end||(r.end=l()),Zt(r,e)},function(){var t=Wt(r);$t(r,e,t)})),e&&(r.cid=e.id,e.updateRemain(1,w)),r.start=l(),n.apply(this,arguments)}}function nn(t){t&&i[t]&&Object.defineProperty(i,t,{configurable:!0,enumerable:!0,writable:!0,value:tn(t)})}function en(){Xt||Qt();var n={};return Kt.forEach(function(t){n[t]=tn(t)}),n}function rn(){Xt||Qt(),Kt.forEach(function(t){nn(t)})}i.onNetworkStatusChange(function(t){a.networkType=t.networkType});var an=!1;function on(t){(!t||0<=it(a,E))&&(st(),Pt(),Gt(),Yt(),rn()),t&&Object.assign(zt,en()||{})}function cn(t){if(!an){j(t||{});var n=an=!0;null!=R.plugin&&(n=R.plugin),on(n)}}function un(){return zt.config=cn,zt}var sn=un();module.exports=sn;